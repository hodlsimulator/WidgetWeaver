WidgetWeaver – chat handoff (copy/paste)
Last updated: 2026-01-31

Product
- WidgetWeaver is an iOS 26+ app that builds and previews real WidgetKit widgets via an Explore (template catalogue) + context-aware editor workflow.
- Widgets must be deterministic and budget-safe; heavy work (Vision, ranking, photo prep) happens in the app; widgets render from App Group state.
- Sharing/export uses a `.wwdesign` design package file type (JSON under the hood) for backup and exchange.

Strategic intent
- “Super complex, super simple”: powerful capabilities under the hood, but progressive disclosure in the UI.
- Ship a coherent flagship set, not a wide permission-heavy grab bag.

Near-term schedule
- Today: 2026-01-31.
- Feature freeze: end of day 2026-02-02 (Europe/Dublin) (stop adding features).
- Polish: 2026-02-03 to 2026-02-14.
- Target ship: 2026-02-14 to 2026-02-16.

Current roadmap priorities (freeze + polish window)
1) Photos: Smart Photos + crop tools + filters should feel flagship (fast, reliable, good defaults, deterministic widget renders).
2) Clock: Home Screen correctness and predictable customisation; Segmented face hardening (third face).
3) Reminders: Smart Stack v2 behaviour (names + no duplicates) + stability in the widget.
4) AI: keep it safe (review-before-apply + undo + kill-switch) with token-mapping parity; do not jeopardise core edit → save flow.
5) Noise Machine: keep responsiveness rock-solid; fade improvements and small polish only.
6) Widget design themes: theme-first styling presets to keep templates cohesive; wire the theme picker into the Style tool and apply to drafts (style-only; no schema/render changes).
7) App appearance themes: finalise contrast/readability and ensure themes don’t fight the editor.
8) Weather: stable caching + clear permission flow + attribution. (Already in good shape; keep it boring.)
9) Variables: keep discoverable (built-in browser + syntax reference + snippet insertion).

Recent progress check-in (what is now implemented)

AI
- Master AI kill-switch exists (App Group) so all AI surfaces can be disabled quickly: `WidgetWeaverFeatureFlags.aiEnabled`.
- Review-before-apply mode exists behind an App Group flag (`WidgetWeaverFeatureFlags.aiReviewUIEnabled`):
  - Generate/patch return a candidate result shown in a review sheet (preview + Apply/Cancel).
  - One-tap “Undo last AI apply” exists when a snapshot is available.
- Apple Intelligence availability is surfaced next to AI controls, and deterministic fallbacks remain supported.
- AI prompt context redacts image file names (context summarises image presence/specs, not file paths).

Clock
- Clock faces are first-class and selectable in-editor:
  - Ceramic + Icon are established.
  - Segmented is the third face and is still being hardened (geometry/pixel alignment/diagnostics).
- Segmented diagnostics overlays exist behind App Group flags:
  - `WidgetWeaverFeatureFlags.segmentedRingDiagnosticsEnabled`
  - `WidgetWeaverFeatureFlags.segmentedBezelDiagnosticsEnabled`
- A debug “clock face gallery” exists to capture/update the baseline artefact (`Docs/ClockFaceBaseline.png`).

App appearance themes
- Appearance sheet exists (toolbar menu → Appearance).
- App appearance themes are persisted per-device via `@AppStorage` and applied immediately; “Paper” forces a light appearance.

Widget design themes (style presets)
- Widget design themes are curated presets that overwrite widget styling (`StyleSpec`) in one deterministic operation (no schema or renderer changes).
- Presets and catalogue live in Shared (`Shared/WidgetWeaverThemePreset.swift`).
- Pure applier exists (`Shared/WidgetWeaverThemeApplier.swift`) and is covered by smoke tests.
- `WidgetSpecStore.bulkUpdate(...)` exists to support bulk theme application without widget reload storms.
- Theme picker UI row exists as a self-contained feature module:
  - `WidgetWeaver/Features/Themes/WidgetWeaverThemePickerRow.swift`
  - Selected preset ID is persisted per-device via `@AppStorage("widgetweaver.theme.selectedPresetID")`.
  - It is not yet wired into the editor Style tool (next step).

Editor (design browsing/switching)
- Design thumbnails are used in the Library list and in the design picker (thumbnail-first browsing).
- Switching designs is guarded when there are unsaved changes (Save & Switch / Discard & Switch / Cancel).

Photos (filters + crop tools)
- Photo filters are implemented as a non-destructive render-time step:
  - Filter token + intensity stored in the spec (`PhotoFilterSpec` via `ImageSpec.filter`).
  - Editor UI includes a thumbnail strip + intensity slider, and an “original vs filtered” compare preview.
  - Kill-switch exists: `WidgetWeaverFeatureFlags.photoFiltersEnabled` (default on).
- Smart Photo crop editor supports manual crop tooling that persists metadata:
  - crop rect (normalised)
  - straighten (degrees)
  - quarter-turn rotation (90° steps)
  - filter-aware previews where relevant

Reminders (Smart Stack v2 names + no duplicates)
- Smart Stack v2 behaviour is defined and implemented:
  - Six pages in fixed order: Overdue → Today → Upcoming → High priority → Anytime → Lists.
  - Strict deduplication per snapshot: a reminder ID appears on at most one page for that refresh.
  - Deterministic ordering in every page with a stable tie-break by reminder ID.
- The mode labels in the editor update based on `smartStackKitVersion` (v1 labels vs v2 page names).

Noise Machine
- Start/stop now uses a master-volume fade (fade in/out) to reduce pops/hard transitions.
- Engine stop includes a short grace period to avoid thrashing when the user toggles rapidly.

Still worth tracking (non-blockers, but visible)
- Segmented clock face is still in progress; continue hardening against Home Screen rendering and tiny sizes (44/60) before calling it “done”.
- Widget design themes are not wired into the Style tool yet; after wiring, verify that theme application is style-only and does not trigger reload storms.
- AI review UI has no toolbar toggle; if it needs broader internal testing, consider adding a DEBUG toggle (or keep using the App Group defaults key).
- Photo Filters are verified on Home Screen (budget-safe); keep a light sanity check in worst-case combinations during QA, but treat the feature as “done”.
- Some editor actions / App Intents may still call `WidgetCenter.shared.reloadAllTimelines()` directly. Prefer `WidgetWeaverWidgetReloadCoordinator` or targeted `reloadTimelines(ofKind:)` to match the newer reload discipline.

Key repo pointers
- Feature flags (App Group, shared by app + widget): `Shared/WidgetWeaverFeatureFlags.swift`
- AI:
  - Service + schema mapping: `WidgetWeaver/WidgetSpecAIService.swift`
  - Candidate pipeline: `WidgetWeaver/WidgetSpecAIService+Candidate.swift`
  - Review UI: `WidgetWeaver/Features/AI/WidgetWeaverAIReviewSheet.swift`
  - Editor wiring: `WidgetWeaver/Features/AI/ContentView+AICandidateActions.swift`, `WidgetWeaver/ContentView+Sections.swift`
  - Undo snapshot store: `WidgetWeaver/Features/AI/WidgetSpecAISnapshotStore.swift`
- Design export/import Transferable: `WidgetWeaver/ContentView+SharePackage.swift` (`.wwdesign` files)
- Import review + preview UI: `WidgetWeaver/Features/ImportReview/*`
- Document type registration: `WidgetWeaver/Info.plist` (UTType export + document type + open-in-place declaration)
- Privacy usage strings: `WidgetWeaver/Info.plist` (Location / Photos / etc.)
- App appearance themes:
  - Theme definitions: `WidgetWeaver/WidgetWeaverAppAppearance.swift`
  - Theme picker UI: `WidgetWeaver/WidgetWeaverAppearanceView.swift`
- Widget design themes:
  - Presets + catalogue: `Shared/WidgetWeaverThemePreset.swift`
  - Spec applier: `Shared/WidgetWeaverThemeApplier.swift`
  - Store bulk update (future bulk apply): `Shared/WidgetSpecStore.swift` (`bulkUpdate`)
  - Picker UI row: `WidgetWeaver/Features/Themes/WidgetWeaverThemePickerRow.swift`
- Design thumbnails + guarded switching:
  - Thumbnail renderer: `WidgetWeaver/WidgetPreviewThumbnail.swift`
  - Guarded design picker: `WidgetWeaver/WidgetWeaverDesignSwitchGuardedPicker.swift`
  - Library list row: `WidgetWeaver/ContentView.swift` (`libraryRow(spec:)`)
- Photo filters:
  - Filter engine: `Shared/PhotoFilterEngine.swift`
  - Filter spec: `Shared/PhotoFilterSpec.swift`
  - Editor UI: `WidgetWeaver/ContentView+SectionsMedia.swift`
- Smart Photos pipeline:
  - `WidgetWeaver/SmartPhotoPipeline.swift`
  - `WidgetWeaver/SmartPhotoPipeline+CropDecision.swift`
  - Crop editor: `WidgetWeaver/SmartPhotoCropEditorView.swift`
  - Manual crop renderer: `WidgetWeaver/SmartPhotoManualCropRenderer.swift`
- Reminders:
  - Engine (EventKit, app-only): `Shared/WidgetWeaverRemindersEngine.swift`
  - Snapshot store (App Group): `Shared/WidgetWeaverRemindersStore.swift`
  - Template view: `Shared/WidgetWeaverRemindersTemplateView.swift`
  - Config/schema: `Shared/WidgetWeaverRemindersConfig.swift`
  - Smart Stack v2 partitioner: `Shared/WidgetWeaverRemindersSmartStackV2Partitioner.swift`
  - Smart Stack kit upgrader: `Shared/WidgetWeaverRemindersSmartStackKitUpgrader.swift`
  - Behaviour spec: `Docs/Reminders/Reminders Smart Stack v2 Spec.md`
- Clock:
  - Home Screen widget: `WidgetWeaverWidget/WidgetWeaverHomeScreenClockWidget.swift`
  - Appearance resolver: `Shared/WidgetWeaverClockAppearanceResolver.swift`
  - Face model + render: `Shared/Clock/*`
  - Clock live view: `WidgetWeaverWidget/Clock/WidgetWeaverClockWidgetLiveView.swift`
- Weather pipeline:
  - Engine (fetch + throttling): `Shared/WidgetWeaverWeatherEngine.swift`
  - Store (App Group): `Shared/WidgetWeaverWeatherStore.swift`
  - Template views: `Shared/WidgetWeaverWeatherTemplateView.swift` (and related `*NowcastChart*`, `*Layouts*`, `*Components*`)
  - Deep-link host: `WidgetWeaver/WidgetWeaverWeatherDeepLinkHost.swift`
  - Settings UX: `WidgetWeaver/WidgetWeaverWeatherSettingsView.swift`
  - Widget integration: `WidgetWeaverWidget/WidgetWeaverWidget.swift` (weather body)
- Noise Machine:
  - Controller + engine (fade): `Shared/NoiseMachine/NoiseMachineController+Engine.swift`
  - Widget: `WidgetWeaverWidget/NoiseMachine/*`
- Widget reload coordinator: `Shared/WidgetWeaverWidgetReloadCoordinator.swift`
- Variable resolution: `Shared/WidgetSpec+Utilities.swift`, `Shared/WidgetSpec+VariableResolutionNow.swift`
- Variables UI: `WidgetWeaver/WidgetWeaverVariablesView.swift` (and related sheets)
- Variables reference: `Docs/VARIABLES.md` (syntax, filters, built-in keys, and Now formats including Unix milliseconds)

Feature removal / hiding pointers
- “Reading” template surfaces: `WidgetWeaver/WidgetWeaverAboutCatalog.swift` (and any Explore listings)
- “Photo Quote” template: `WidgetWeaver/WidgetWeaverAboutCatalog.swift`, `Shared/WidgetSpec+Utilities.swift` (spec helper)
- Clipboard Actions (parked; must be absent in release builds):
  - Widget registration: `WidgetWeaverWidget/WidgetWeaverWidgetBundle.swift` (gate behind the compiler flag `CLIPBOARD_ACTIONS`; release builds must not define it)
  - Widget: `WidgetWeaverWidget/WidgetWeaverClipboardActionsWidget.swift`
  - App intents (auto-detect + inbox): `WidgetWeaver/WidgetWeaverClipboardInboxIntents.swift` (contact creation disabled; must not ship as a surfaced feature)
  - Xcode project dependency: `WidgetWeaver.xcodeproj/project.pbxproj` (must remain clean: no `XCLocalSwiftPackageReference`; ScreenActionsCore must be absent from the default build)
- PawPulse / “Latest Cat”:
  - Widget registration gate: `WidgetWeaverWidget/WidgetWeaverWidgetBundle.swift` (`#if PAWPULSE`)
  - Widget: `WidgetWeaverWidget/WidgetWeaverPawPulseLatestCatWidget.swift`
  - App views/settings: `Shared/PawPulseLatestCatDetailView.swift`, `Shared/PawPulseSettingsView.swift`
  - Runtime gating helper: `Shared/WidgetWeaverFeatureFlags.swift` (`pawPulseEnabled`, default off)
  - Background tasks: `Shared/PawPulseBackgroundTasks.swift` (runtime gated; cancels pending requests when disabled or when no base URL is configured)

Non-negotiables
- Do not run heavy work in widgets.
- Do not introduce WidgetCenter reload loops from widget providers.
- Do not break existing user widgets when removing templates from Explore.
- Do not ship a build that requests Contacts permission or declares Contacts usage strings.
- Do not ship a build that can request Location authorisation without `NSLocationWhenInUseUsageDescription` in Info.plist.
- Clipboard Actions is parked: release builds must not register it in the widget gallery and must not depend on ScreenActionsCore.
