WidgetWeaver – chat handoff (copy/paste)
Last updated: 2026-01-26

Product
- WidgetWeaver is an iOS 26+ app that builds and previews real WidgetKit widgets via an Explore (template catalogue) + context-aware editor workflow.
- Widgets must be deterministic and budget-safe; heavy work (Vision, ranking, photo prep) happens in the app; widgets render from App Group state.
- Sharing/export uses a `.wwdesign` design package file type (JSON under the hood) for backup and exchange.

Strategic intent
- “Super complex, super simple”: powerful capabilities under the hood, but progressive disclosure in the UI.
- Ship a coherent flagship set, not a wide permission-heavy grab bag.

Near-term schedule
- Today: 2026-01-26.
- Feature freeze: 2026-01-31 (stop adding features).
- Polish: 2026-02-01 to 2026-02-14.
- Target ship: 2026-02-14 to 2026-02-16.

Current roadmap priorities (pre-freeze)
1) Photos: make Smart Photos + poster/photo widgets feel flagship (fast, reliable, good defaults).
2) Clock: Home Screen correctness and predictable customisation updates.
3) Weather (flagship): ship the rain-first Weather template + `__weather_*` variables with a clear location flow, stable caching, and attribution.
4) Noise Machine: promote it; keep responsiveness rock-solid; add 1–2 scoped upgrades only.
5) Variables: make them more accessible/discoverable, especially during text editing; surface built-in keys and syntax.
6) AI: upgrade the Pro “Generate” and “Patch” flows so they are reviewable and undoable (no silent saves), with token-mapping parity and an App Group kill-switch. Roadmap: `Docs/ROADMAP_AI_2026-01.md`.
7) Catalogue and trust clean-up (usefulness-first; do not break existing widgets) — status (snapshot 4c7c51e9):
   - “Reading” is hidden from Explore/starter surfaces (kept in the app for back-compat).
   - “Photo Quote” is hidden from Explore/starter surfaces (kept in the app for back-compat).
   - Legacy “Quote” starter template is not surfaced (any remaining `starter-quote` usage is for legacy/icon mapping only).
   - Clipboard Actions (Screen Actions) is parked for this ship and is absent from release builds:
     - Compile-time gated behind `CLIPBOARD_ACTIONS` (release builds must not define it).
     - Not listed in Explore/starter surfaces.
     - Not registered in the widget extension bundle (no Home Screen “Add Widget” gallery presence).
     - Default build has no ScreenActionsCore dependency and no local-path SPM dependencies in the Xcode project.
     - `NSContactsUsageDescription` does not exist in `WidgetWeaver/Info.plist` (nor InfoPlist.strings).
   - PawPulse / “Latest Cat” is treated as a future feature:
     - Compile-time gated (no widget gallery presence unless `PAWPULSE` is defined).
     - Background refresh is runtime gated (`WidgetWeaverFeatureFlags.pawPulseEnabled`, default off) and refresh scheduling is cancelled when disabled or when no base URL is configured.
   - Weather location safety: `WidgetWeaver/Info.plist` contains `NSLocationWhenInUseUsageDescription` with a user-facing explanation. Keep the permission request in-context (“Use Current Location” only).


Recent progress check-in (what is now implemented)
- Weather usefulness: unconfigured Weather widgets deep-link into Weather settings (tap opens `widgetweaver://weather/settings`), routed via `WidgetWeaverWeatherDeepLinkHost`.
- Weather reliability: refresh throttling (`shouldAttemptRefresh`, `lastRefreshAttemptAt`) plus a small WeatherKit retry/backoff; minute forecast and attribution are best-effort.
- Weather store hardening: decoding failures clear corrupt data; App Group / standard defaults healing exists; clearing the saved location clears snapshot/attribution and refresh timestamps.
- Variables: in-app built-in key browser + syntax/filters reference + one-tap snippet insertion; built-ins intentionally override custom keys; docs are in `Docs/VARIABLES.md`.
- Design exchange: `.wwdesign` import review exists, including an import preview sheet that renders Small/Medium/Large previews before import.
- Widget reload discipline: a reload coordinator exists to coalesce/debounce reload requests and reload known widget kinds rather than using `reloadAllTimelines()`.
- Smart Photos correctness: crop decision logic is isolated (family-specific; subject-aware framing), tightening preview vs Home Screen consistency.
- Clock correctness: appearance resolves through a single resolver to reduce preview vs Home Screen drift.

Still worth tracking (non-blockers, but visible)
- “Reading” and “Photo Quote” are hidden from Explore, not deleted. If the goal is full removal, there is further catalogue/spec clean-up to do.
- Some App Intents and editor actions still call `WidgetCenter.shared.reloadAllTimelines()` directly. Migrate them to `WidgetWeaverWidgetReloadCoordinator` (or targeted `reloadTimelines(ofKind:)`) to match the newer reload discipline.

Key repo pointers
- AI service (prompt → spec + patching): WidgetWeaver/WidgetSpecAIService.swift
- Design export/import Transferable: WidgetWeaver/ContentView+SharePackage.swift (`.wwdesign` files)
- Import review + preview UI: WidgetWeaver/Features/ImportReview/*
- Document type registration: WidgetWeaver/Info.plist (UTType export + document type + open-in-place declaration)
- Privacy usage strings: WidgetWeaver/Info.plist (Location / Photos / etc.)
- Smart Photos pipeline:
  - WidgetWeaver/SmartPhotoPipeline.swift
  - WidgetWeaver/SmartPhotoPipeline+CropDecision.swift
  - Crop editor: WidgetWeaver/SmartPhotoCropEditorView.swift
- Poster background/overlay: Shared/WidgetWeaverSpecView+Background.swift, Shared/WidgetWeaverSpecView.swift
- Home Screen clock widget: WidgetWeaverWidget/WidgetWeaverHomeScreenClockWidget.swift
- Clock appearance resolver: Shared/WidgetWeaverClockAppearanceResolver.swift
- Clock live view: WidgetWeaverWidget/Clock/WidgetWeaverClockWidgetLiveView.swift
- Weather pipeline:
  - Engine (fetch + throttling): Shared/WidgetWeaverWeatherEngine.swift
  - Store (App Group): Shared/WidgetWeaverWeatherStore.swift
  - Template views: Shared/WidgetWeaverWeatherTemplateView.swift (and related `*NowcastChart*`, `*Layouts*`, `*Components*`)
  - Deep-link host: WidgetWeaver/WidgetWeaverWeatherDeepLinkHost.swift
  - Settings UX: WidgetWeaver/WidgetWeaverWeatherSettingsView.swift
  - Widget integration: WidgetWeaverWidget/WidgetWeaverWidget.swift (weather body)
- Noise Machine widget: WidgetWeaverWidget/WidgetWeaverNoiseMachineWidget.swift
- Template catalogue entries: WidgetWeaver/WidgetWeaverAboutCatalog.swift
- Widget reload coordinator: Shared/WidgetWeaverWidgetReloadCoordinator.swift
- Variable resolution: Shared/WidgetSpec+Utilities.swift, Shared/WidgetSpec+VariableResolutionNow.swift
- Variables UI: WidgetWeaver/WidgetWeaverVariablesView.swift (and related sheets)
- Variables reference: Docs/VARIABLES.md (syntax, filters, built-in keys, and Now formats including Unix milliseconds).

Feature removal / hiding pointers
- “Reading” template surfaces: WidgetWeaver/WidgetWeaverAboutCatalog.swift (and any Explore listings)
- “Photo Quote” template: WidgetWeaver/WidgetWeaverAboutCatalog.swift, Shared/WidgetSpec+Utilities.swift (spec helper)
- Clipboard Actions (parked; must be absent in release builds):
  - Widget registration: WidgetWeaverWidget/WidgetWeaverWidgetBundle.swift (gate behind the compiler flag `CLIPBOARD_ACTIONS`; release builds must not define it)
  - Widget: WidgetWeaverWidget/WidgetWeaverClipboardActionsWidget.swift
  - App intents (auto-detect + inbox): WidgetWeaver/WidgetWeaverClipboardInboxIntents.swift (contact creation disabled; must not ship as a surfaced feature)
  - Xcode project dependency: WidgetWeaver.xcodeproj/project.pbxproj (must remain clean: no `XCLocalSwiftPackageReference`; ScreenActionsCore must be absent from the default build)
- PawPulse / “Latest Cat”:
  - Widget registration gate: WidgetWeaverWidget/WidgetWeaverWidgetBundle.swift (`#if PAWPULSE`)
  - Widget: WidgetWeaverWidget/WidgetWeaverPawPulseLatestCatWidget.swift
  - App views/settings: Shared/PawPulseLatestCatDetailView.swift, Shared/PawPulseSettingsView.swift
  - Runtime gating helper: Shared/WidgetWeaverFeatureFlags.swift (`pawPulseEnabled`, default off)
  - Background tasks: Shared/PawPulseBackgroundTasks.swift (runtime gated; cancels pending requests when disabled or when no base URL is configured)

Non-negotiables
- Do not run heavy work in widgets.
- Do not introduce WidgetCenter reload loops from widget providers.
- Do not break existing user widgets when removing templates from Explore.
- Do not ship a build that requests Contacts permission or declares Contacts usage strings.
- Do not ship a build that can request Location authorisation without `NSLocationWhenInUseUsageDescription` in Info.plist.
- Clipboard Actions is parked: release builds must not register it in the widget gallery and must not depend on ScreenActionsCore.
